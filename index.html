<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Overview Pivots</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
  <style>
    :root {
      color-scheme: dark light;
      --bg: #0f1216;
      --panel: #161b22;
      --border: #253046;
      --text: #e7ecf3;
      --muted: #94a3b8;
      --accent: #2563eb;
      --shadow: 0 12px 32px rgba(15, 23, 42, 0.35);
    }

    body.light {
      --bg: #f7f9fc;
      --panel: #ffffff;
      --border: #d2d7e0;
      --text: #0f172a;
      --muted: #475569;
      --accent: #2563eb;
      --shadow: 0 10px 24px rgba(15, 23, 42, 0.18);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: clamp(16px, 4vw, 32px);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0) 100%);
    }

    h1 {
      margin: 0;
      font-size: clamp(20px, 4vw, 28px);
      font-weight: 800;
      letter-spacing: 0.4px;
    }

    main {
      flex: 1;
      padding: clamp(16px, 4vw, 40px);
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .tabs {
      display: inline-flex;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 4px;
      background: var(--panel);
      box-shadow: var(--shadow);
    }

    .tab {
      border: none;
      background: var(--panel);
      color: var(--text);
      font-weight: 700;
      padding: 10px 18px;
      border-radius: 999px;
      cursor: default;
    }

    .tab:not(.active) {
      opacity: 0.45;
    }

    .kpis {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
    }

    .kpi-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .kpi-card.is-na .kpi-value {
      color: var(--muted);
    }

    .kpi-label {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      font-weight: 700;
      color: var(--muted);
    }

    .kpi-value {
      font-size: clamp(28px, 5vw, 40px);
      font-weight: 800;
      letter-spacing: 0.6px;
      word-break: break-word;
    }

    .status {
      color: var(--muted);
      font-weight: 600;
      min-height: 24px;
    }

    .error {
      color: #f87171;
    }

    @media (max-width: 600px) {
      header {
        flex-direction: column;
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Overview Pivots</h1>
    <div class="tabs" role="tablist" aria-label="Overview tabs">
      <button class="tab active" type="button" role="tab" aria-selected="true">Overview Pivots</button>
    </div>
  </header>

  <main>
    <p class="status" id="status" role="status">Loading data…</p>
    <section class="kpis" aria-live="polite">
      <article class="kpi-card" aria-label="Spend">
        <span class="kpi-label">Spend</span>
        <span class="kpi-value" id="spendValue">–</span>
      </article>
      <article class="kpi-card" aria-label="Sales">
        <span class="kpi-label">Sales</span>
        <span class="kpi-value" id="salesValue">–</span>
      </article>
    </section>
  </main>

  <script>
    const DEFAULT_FILE_PATH = "./Products Advertised Product.xlsx";
    const STATUS_ELEMENT = document.getElementById("status");
    const spendValueEl = document.getElementById("spendValue");
    const salesValueEl = document.getElementById("salesValue");

    document.addEventListener("DOMContentLoaded", () => {
      loadDefaultWorkbook();
    });

    async function loadDefaultWorkbook() {
      setStatus("Loading data…");
      try {
        const response = await fetch(DEFAULT_FILE_PATH);
        if (!response.ok) {
          throw new Error(`Failed to fetch default workbook (${response.status})`);
        }
        const buffer = await response.arrayBuffer();
        const workbook = XLSX.read(buffer, { type: "array" });
        if (!workbook.SheetNames.length) {
          showNoData();
          return;
        }
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, { defval: null });
        if (!rows.length) {
          showNoData();
          return;
        }

        const columnLookup = buildColumnLookup(rows);
        const spendKey = resolveColumnKey(columnLookup, ["spend", "cost"]);
        const salesKey = resolveColumnKey(columnLookup, ["sales", "revenue", "sale amount"]);

        const spendTotal = sumColumnValues(rows, spendKey);
        const salesTotal = sumColumnValues(rows, salesKey);

        updateKpi(spendValueEl, spendTotal);
        updateKpi(salesValueEl, salesTotal);
        setStatus("Data loaded from Products Advertised Product.xlsx");
      } catch (error) {
        console.error(error);
        setStatus("Unable to load default data.", true);
        updateKpi(spendValueEl, null);
        updateKpi(salesValueEl, null);
      }
    }

    function normalizeHeader(header) {
      return typeof header === "string" ? header.trim().toLowerCase() : "";
    }

    function buildColumnLookup(rows) {
      const map = new Map();
      for (const row of rows) {
        if (!row) continue;
        for (const key of Object.keys(row)) {
          const normalized = normalizeHeader(key);
          if (normalized && !map.has(normalized)) {
            map.set(normalized, key);
          }
        }
      }
      return map;
    }

    function resolveColumnKey(columnMap, targets) {
      for (const target of targets) {
        const normalized = normalizeHeader(target);
        if (columnMap.has(normalized)) {
          return columnMap.get(normalized);
        }
      }
      return null;
    }

    function sumColumnValues(rows, columnKey) {
      if (!columnKey) {
        return null;
      }
      let total = 0;
      let hasValue = false;
      for (const row of rows) {
        if (!row || !(columnKey in row)) continue;
        const value = toNumber(row[columnKey]);
        if (Number.isFinite(value)) {
          total += value;
          hasValue = true;
        }
      }
      return hasValue ? total : null;
    }

    function toNumber(value) {
      if (value === null || value === undefined || value === "") return null;
      if (typeof value === "number") return value;
      if (typeof value === "string") {
        const cleaned = value.replace(/[^0-9.\-]+/g, "");
        if (!cleaned) return null;
        const number = Number(cleaned);
        return Number.isFinite(number) ? number : null;
      }
      return null;
    }

    function updateKpi(element, amount) {
      const card = element.closest(".kpi-card");
      if (!card) return;
      if (amount === null) {
        element.textContent = "N/A";
        card.classList.add("is-na");
        return;
      }
      element.textContent = formatCurrency(amount);
      card.classList.remove("is-na");
    }

    function formatCurrency(value) {
      try {
        return new Intl.NumberFormat("en-US", {
          style: "currency",
          currency: "USD",
          maximumFractionDigits: 2,
        }).format(value);
      } catch (error) {
        return value.toFixed(2);
      }
    }

    function setStatus(message, isError = false) {
      STATUS_ELEMENT.textContent = message;
      STATUS_ELEMENT.classList.toggle("error", Boolean(isError));
    }

    function showNoData() {
      setStatus("The workbook does not contain any data rows.", true);
      updateKpi(spendValueEl, null);
      updateKpi(salesValueEl, null);
    }
  </script>
</body>
</html>
